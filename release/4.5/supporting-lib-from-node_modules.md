# Supporting lib from node\_modules

DOMの型定義 `lib.dom.ts` を差し替えできるようになった。

## lib.dom.tsとは何ぞ？

ブラウザのDOM APIが定義されたファイル。\
`localStrage` だったり `setTimeout` だったり `fetch` だったり、イメージ的には「グローバルに生えているAPI」に近い。

```javascript
// 今は当たり前のように使えるこれらのAPI。
setTimeout(() => {
  fetch("https://foo.com");
}, 1000);

// 昔は「fetch」ってなかったよね？
setTimeout(() => { // だいぶ昔からあった
  fetch("https://foo.com"); // 昔はなかった
}, 1000);

// いつから使えるようになった....？
```

lib.dom.tsはTypeScriptをインストールした時に一緒にくっついてくる。

{% tabs %}
{% tab title="package.json" %}
```javascript
"dependencies": {
  "typescript": "4.1.5",
}
```
{% endtab %}

{% tab title="node_modules/@typescript" %}
```shell
lib.dom.ts
lib.es2015.object.d.ts
lib.es2015.promise.d.ts
lib.es2015.iterable.d.ts
```
{% endtab %}
{% endtabs %}

lib.object.d.tsなんかもあるが、これらはバージョン管理されているのでtsconfig.jsonでどのバージョンを参照するか切り替えることができる。

{% tabs %}
{% tab title="tsconfig.json" %}
```javascript
"lib": [
  "dom",
  "es2020"
]
```
{% endtab %}

{% tab title="node_modules/@typescript" %}
```bash
lib.dom.ts

# lib:["es2015"]ならコレ
lib.es2015.object.d.ts
lib.es2015.string.d.ts

# lib:["es2020"]ならコレ
lib.es2020.object.d.ts
lib.es2020.string.d.ts

# lib:["es2022"]ならコレ
lib.es2022.object.d.ts
lib.es2022.string.d.ts
```
{% endtab %}
{% endtabs %}

新しいAPIのうち `Object.hasOwn` など「オブジェクトに生えた」ものは「新しいlib.\*\*\*.object.tsを参照すれば良い」ことになるけど、`fetch` なんかの「グローバルに生えた」ものは「lib.dom.tsは1種類しかないから切り替えできないよね」という話。

## lib.dom.tsの本体

lib.dom.tsの本体（というかソース）はTypeScriptのGitHubリポジトリに存在する。

そういえば最近 `structuredClone` を使いたかったけど型の未定義エラーになってしまったので、これを追いかけてみる。\


{% tabs %}
{% tab title="src/app/app.component.ts" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 12.01.40.png" alt=""><figcaption></figcaption></figure>
{% endtab %}

{% tab title="package.json" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 12.02.56.png" alt=""><figcaption></figcaption></figure>
{% endtab %}
{% endtabs %}

[![Edit structured-clone-ts4.1](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/structured-clone-ts4-1-o9hshq?fontsize=14\&hidenavigation=1\&theme=dark)

### "lib.dom.ts" v4.1.5

`structuredClone` が未定義になったv4.1.5。グローバルっぽいオブジェクトを探しても、確かに定義されていない。

<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 12.06.44.png" alt=""><figcaption><p><a href="https://github.com/microsoft/TypeScript/blob/v4.1.5/lib/lib.dom.d.ts#L18649">https://github.com/microsoft/TypeScript/blob/v4.1.5/lib/lib.dom.d.ts#L18649</a></p></figcaption></figure>

### "lib.dom.ts" v4.7.4

あった。

<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 10.59.18.png" alt=""><figcaption><p><a href="https://github.com/microsoft/TypeScript/blob/v4.7.4/lib/lib.dom.d.ts#L16814">https://github.com/microsoft/TypeScript/blob/v4.7.4/lib/lib.dom.d.ts#L16814</a></p></figcaption></figure>

## lib.dom.tsをアップデート（従来）

{% hint style="info" %}
これは従来のやり方。ベストな解決策ではない。
{% endhint %}

TypeScript v4.7に `structuredClone` が存在するなら、そのバージョンをインストールすればいいことになる。

```
npm install typescript@4.7

// lib.dom.tsがv4.7にアップデートされる
// ここにはstructuredCloneが定義されている
```

実際には、フレームワークだったり他のパッケージとの兼ね合いでそんなに気軽にTypeScriptのバージョンは上げられない。コードの一部分だけに影響させたい要求のために、プロジェクトすべてに影響する解決策をとるのは少々リスクが高い。\


## lib.dom.tsをアップデート（新）

{% hint style="success" %}
TypeScript v4.5〜の推奨
{% endhint %}

ようやく本題へ。TypeScript v4.5から **TypeScriptのバージョンを上げずにlib.dom.tsだけ差し替える** ことができるようになった。

オフィシャルでメンテナンスされている「@types/web」パッケージをインストールすることで任意のlib.dom.tsをプロジェクトに取り込むことができる。

[https://www.npmjs.com/package/@types/web](https://www.npmjs.com/package/@types/web)

2022/10時点の最新リリースはv0.0.75だった。

[https://github.com/microsoft/TypeScript-DOM-lib-generator/releases/tag/%40types%2Fweb%400.0.75](https://github.com/microsoft/TypeScript-DOM-lib-generator/releases/tag/%40types%2Fweb%400.0.75)

ソースを追いかけると...。あった `structuredClone` が入っている。

<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 11.42.09.png" alt=""><figcaption><p><a href="https://github.com/microsoft/TypeScript-DOM-lib-generator/blob/%40types/web%400.0.75/baselines/dom.generated.d.ts#L16897">https://github.com/microsoft/TypeScript-DOM-lib-generator/blob/%40types/web%400.0.75/baselines/dom.generated.d.ts#L16897</a></p></figcaption></figure>

という訳で「@types/web」のv0.0.75をインストール。

{% tabs %}
{% tab title="First Tab" %}
```javascript
"dependencies": {
  "@typescript/lib-dom": "npm:@types/web@0.0.75"
}
```
{% endtab %}

{% tab title="node_modules/@typescript/lib-dom" %}

{% endtab %}
{% endtabs %}

## CodeSandBoxで試す

コンパイルエラーは出なくなった。

{% tabs %}
{% tab title="src/app/app.component.ts" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 11.44.04.png" alt=""><figcaption></figcaption></figure>
{% endtab %}

{% tab title="package.json" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 11.58.11.png" alt=""><figcaption></figcaption></figure>
{% endtab %}
{% endtabs %}

[![Edit structured-clone-ts4.1-types](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/structured-clone-ts4-1-types-zbsiyx?fontsize=14\&hidenavigation=1\&theme=dark)
