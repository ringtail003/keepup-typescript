# Supporting lib from node\_modules

DOMの型定義 `lib.dom.d.ts` を差し替えできるようになった。

## lib.dom.tsとは何ぞ？

DOM APIの型定義が書いてあるファイル。

* setTimeout
* window
* fetch

\
イメージ的には「グローバルに生えているAPIの型定義」に近い。

{% code title="TypeScriptのコード" %}
```typescript
setTimeout(() => {
  window.alert("");
  fetch("https://foo.com");
}, 1000);
```
{% endcode %}

{% code title="lib.dom.d.tsから抜粋" %}
```typescript
// setTimeout,window,fetchなどこのファイルで型定義されている。
declare function setTimeout(...): number;

interface Window extends ... {
  alert(message?: any): void;
  ...
}

interface WindowOrWorkerGlobalScope {
  fetch(...): Promise<Response>;
}
```
{% endcode %}

## lib.dom.tsはどこにある？

TypeScriptをインストールした時に一緒にくっついてくる。\
node\_modulesフォルダを覗くと、ファイルとして存在している。

{% tabs %}
{% tab title="package.json" %}
```javascript
"dependencies": {
  "typescript": "4.1.5",
}
```
{% endtab %}

{% tab title="node_modules/@typescript" %}
```shell
lib.dom.ts
lib.es2015.object.d.ts
lib.es2015.promise.d.ts
lib.es2015.iterable.d.ts
lib.es2022.object.d.ts
lib.es2022.promise.d.ts
...
```
{% endtab %}
{% endtabs %}

node\_modulesフォルダにはlib.dom.d.tsの他に「lib.es2015.object.d.ts」や「lib.es2015.promise.d.ts」などのファイルも存在している。これらはtsconfig.jsonの `lib` 指定で「どのファイルを読み込むか」を指定できる。

```typescript
// tsconfig.json
"lib": ["dom", "es2015"]

// node_modules/@typescriptのこれらが読み込まれる
lib.dom.ts
lib.es2015.object.d.ts
lib.es2015.promise.d.ts
```

```typescript
// tsconfig.json
"lib": ["dom", "es2020"]

// node_modules/@typescriptのこれらが読み込まれる
lib.dom.ts
lib.es2020.object.d.ts
lib.es2020.promise.d.ts
```

`es2015` や `es2020` はECMAScriptのバージョンと一致する。\
ECMA2020で新しいAPIが追加されるとTypeScriptが `es2020` のファイル群を追加し、そこに新しいAPIの型定義が書かれる。

例えばECMA2022で追加された `Object.hasOwn` というAPIがある。\
lib.es2022.object.tsを見ると、hasOwnの型定義が書かれている。

[https://github.com/microsoft/TypeScript/blob/main/lib/lib.es2022.object.d.ts](https://github.com/microsoft/TypeScript/blob/main/lib/lib.es2022.object.d.ts)

```typescript
// lib.es2022.object.ts
interface ObjectConstructor {
  ...
  hasOwn(o: object, v: PropertyKey): boolean;
}
```

`lib:["es2022"]` を指定すれば `hasOwn` を使えるようになる。\
それ以前の `lib:["es2015"]` など指定している場合、TypeScriptが `hasOwn` の型を見つけられず型定義エラーになる。

ここで、もう一度node\_modulesフォルダの下を覗いてみよう。

{% tabs %}
{% tab title="node_modules/@typescript" %}
```typescript
lib.dom.d.ts
lib.es2015.object.d.ts
lib.es2015.promise.d.ts
lib.es2015.iterable.d.ts
lib.es2022.object.d.ts
lib.es2022.promise.d.ts
...
```
{% endtab %}
{% endtabs %}

`es2015` や `es2022` はECMA\*\*\*\*という仕様のバージョン番号と一致することが分かった。\
でも `dom` にはバージョン番号がなく、ひとつのファイルしか存在しない。

ECMAScriptではObjectやPromiseだけでなく `fetch` などの「グローバルに生えているAPI」も追加される。「グローバルに生えているAPI」を定義したlib.dom.d.tsはどこでECMAScriptのバージョン指定ができるのか？

## グローバルに生えた新しいAPIが使えない？

そういえば最近 `structuredClone` を使いたかったけど型の未定義エラーになってしまったので、これを追いかけてみる。\


{% tabs %}
{% tab title="src/app/app.component.ts" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 12.01.40.png" alt=""><figcaption></figcaption></figure>
{% endtab %}

{% tab title="package.json" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 12.02.56.png" alt=""><figcaption></figcaption></figure>
{% endtab %}
{% endtabs %}

[![Edit structured-clone-ts4.1](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/structured-clone-ts4-1-o9hshq?fontsize=14\&hidenavigation=1\&theme=dark)

### "lib.dom.d.ts" v4.1.5

`structuredClone` を使って `Cannot find name` エラーになったv4.1.5。グローバルっぽいオブジェクトを探しても、確かに定義されていない。

<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 12.06.44.png" alt=""><figcaption><p><a href="https://github.com/microsoft/TypeScript/blob/v4.1.5/lib/lib.dom.d.ts#L18649">https://github.com/microsoft/TypeScript/blob/v4.1.5/lib/lib.dom.d.ts#L18649</a></p></figcaption></figure>

### "lib.dom.d.ts" v4.7.4

`structuredClone` があった。

<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 10.59.18.png" alt=""><figcaption><p><a href="https://github.com/microsoft/TypeScript/blob/v4.7.4/lib/lib.dom.d.ts#L16814">https://github.com/microsoft/TypeScript/blob/v4.7.4/lib/lib.dom.d.ts#L16814</a></p></figcaption></figure>

## TypeScriptそのものをアップデート（従来）

{% hint style="info" %}
これは従来のやり方。ベストな解決策ではない。
{% endhint %}

TypeScript v4.7に `structuredClone` が存在するなら、そのバージョンをインストールすればいいことになる。

```
npm install typescript@4.7

// lib.dom.tsがv4.7にアップデートされる
// ここにはstructuredCloneが定義されている
```

実際には、フレームワークだったり他のパッケージとの兼ね合いでそんなに気軽にTypeScriptのバージョンは上げられない。ほんの一部分の要求のために、プロジェクトすべてに影響する解決策をとるのはリスクが高い。\


## lib.dom.d.tsをアップデート（新）

{% hint style="success" %}
TypeScript v4.5〜の推奨
{% endhint %}

ようやく本題へ。TypeScript v4.5から **TypeScriptのバージョンを上げずにlib.dom.d.tsだけ差し替える** ことができるようになった。

オフィシャルでメンテナンスされている「@types/web」パッケージをインストールすることで任意のlib.dom.d.tsをプロジェクトに取り込むことができる。

[https://www.npmjs.com/package/@types/web](https://www.npmjs.com/package/@types/web)

「@types/web」の2022/10時点の最新リリースはv0.0.75だった。

[https://github.com/microsoft/TypeScript-DOM-lib-generator/releases/tag/%40types%2Fweb%400.0.75](https://github.com/microsoft/TypeScript-DOM-lib-generator/releases/tag/%40types%2Fweb%400.0.75)

ソースを追いかけると...。あった `structuredClone` が入っている。

<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 11.42.09.png" alt=""><figcaption><p><a href="https://github.com/microsoft/TypeScript-DOM-lib-generator/blob/%40types/web%400.0.75/baselines/dom.generated.d.ts#L16897">https://github.com/microsoft/TypeScript-DOM-lib-generator/blob/%40types/web%400.0.75/baselines/dom.generated.d.ts#L16897</a></p></figcaption></figure>

という訳で「@types/web」のv0.0.75をインストール。

{% tabs %}
{% tab title="package.json" %}
```javascript
"dependencies": {
  "@typescript/lib-dom": "npm:@types/web@0.0.75"
}
```
{% endtab %}

{% tab title="node_modules/@typescript" %}
```typescript
lib.dom.d.ts
lib.es2015.object.d.ts
lib.es2015.string.d.ts
lib.es2020.object.d.ts
lib.es2020.string.d.ts
lib.es2022.object.d.ts
lib.es2022.string.d.ts
```
{% endtab %}

{% tab title="node_modules/@typescript/lib-dom" %}
```typescript
lib.dom.d.ts
```
{% endtab %}
{% endtabs %}

## グローバルに生えた新しいAPIが使えるようになった

`structuredClone` の型定義が見つかるようになり、コンパイルエラーは出なくなった。

{% tabs %}
{% tab title="src/app/app.component.ts" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 11.44.04.png" alt=""><figcaption></figcaption></figure>
{% endtab %}

{% tab title="package.json" %}
<figure><img src="../../.gitbook/assets/スクリーンショット 2022-10-10 11.58.11.png" alt=""><figcaption></figcaption></figure>
{% endtab %}
{% endtabs %}

[![Edit structured-clone-ts4.1-types](https://codesandbox.io/static/img/play-codesandbox.svg)](https://codesandbox.io/s/structured-clone-ts4-1-types-zbsiyx?fontsize=14\&hidenavigation=1\&theme=dark)

## ２つのlib.dom.d.ts

TypeScriptに同梱されたlib.dom.d.tsと「@types/web」に同梱されたlib.dom.d.ts。\
ローカルのプロジェクトには２つのlib.dom.d.tsが存在する。

```typescript
// node_modules/@typescript
lib.dom.d.ts
lib.es2015.object.d.ts
lib.es2015.string.d.ts
lib.es2020.object.d.ts
lib.es2020.string.d.ts
...
```

```typescript
// node_modules/@types/web
lib.dom.d.ts
```

「@types/web」が存在する場合、このフォルダのlib.dom.d.tsが読み込まれる。\
これが今回のアップデート「Supporting lib from node\_modules」で追加されたもの。
